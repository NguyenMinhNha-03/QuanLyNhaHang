CREATE TABLESPACE ql_nhahang
DATAFILE 'nhahang_data_file.dbf' SIZE 100M
AUTOEXTEND ON NEXT 50M MAXSIZE UNLIMITED;

CREATE USER C##QL_NhaHang IDENTIFIED BY 123
DEFAULT TABLESPACE users
TEMPORARY TABLESPACE temp
QUOTA UNLIMITED ON users
QUOTA 100M ON ql_nhahang;

grant create table to C##QL_NhaHang;
grant create trigger to C##QL_NhaHang;
grant create procedure to C##QL_NhaHang;
GRANT ALL PRIVILEGES TO C##QL_NhaHang;

------------------BANG NHAN VIEN--------------------
CREATE TABLE nhanvien (
    manhanvien CHAR(10) NOT NULL PRIMARY KEY,
    tennv      NVARCHAR2(50),
    ngaysinh   DATE,
    gioitinh   NVARCHAR2(3),
    sdt        CHAR(11),
    chucvu     NVARCHAR2(30) NOT NULL,
    CHECK ( gioitinh IN ( 'Nam', 'Nu' ) ),
    CHECK ( chucvu IN ( 'Quan li', 'Nhan vien tai quay' ) )
);

-------------------BANG CHAM CONG ---------------------
CREATE TABLE bangchamcong (
    machamcong    NUMBER
        GENERATED BY DEFAULT AS IDENTITY
    NOT NULL PRIMARY KEY,
    manhanvien    CHAR(10),
    calam         NVARCHAR2(50),
    giobatdaulam  TIMESTAMP,
    gioketthuclam TIMESTAMP,
    sogiolam      FLOAT    ,
    CONSTRAINT fk_bangchamcong_nhanvien FOREIGN KEY (manhanvien) REFERENCES nhanvien(manhanvien)
);

--------------------BANG TAI KHOAN-------------------------
CREATE TABLE taikhoan (
    madn         NUMBER
        GENERATED BY DEFAULT AS IDENTITY
    NOT NULL PRIMARY KEY,
    username     NVARCHAR2(255) NOT NULL UNIQUE,
    password     NVARCHAR2(255) NOT NULL UNIQUE,
    quyentruycap NUMBER NOT NULL CHECK ( quyentruycap IN ( 0, 1 ) ),
    manv         CHAR(10),
    CONSTRAINT fk_taikhoan_nhanvien FOREIGN KEY ( manv )
        REFERENCES nhanvien ( manhanvien )
);
--------------------BANG NHA CUNG CAP------------------------
CREATE TABLE nhacungcap (
    mancc     CHAR(10) NOT NULL PRIMARY KEY,
    tenncc    NVARCHAR2(50),
    diachincc NVARCHAR2(50)
);
-------------------BANG NGUYEN LIEU------------------------
CREATE TABLE nguyenlieu (
    manguyenlieu  CHAR(10) NOT NULL PRIMARY KEY,
    tennguyenlieu NVARCHAR2(50),
    donvitinh     NVARCHAR2(20),
    CHECK ( donvitinh IN ( 'Chai', 'Kg', 'Con', 'Goi', 'Bo',
                           'Qua' ) )
);
--------------------BANG PHIEU NHAP------------------------
CREATE TABLE phieunhap (
    maphieunhap  CHAR(10) NOT NULL PRIMARY KEY,
    ngaynhap     DATE,
    tongtiennhap NUMBER,
    mancc        CHAR(10),
    CONSTRAINT fk_phieunhap_nhacungcap FOREIGN KEY ( mancc )
        REFERENCES nhacungcap ( mancc )
);
-------------------BANG CHI TIET PHIEU NHAP---------------------
CREATE TABLE chitietphieunhap (
    mactpn        CHAR(10) NOT NULL PRIMARY KEY,
    manl          CHAR(10),
    mapn          CHAR(10),
    manv          CHAR(10),
    hansudung     DATE,
    soluongnhap   NUMBER CHECK ( soluongnhap > 0 ),
    dongianhap    NUMBER CHECK ( dongianhap > 0 ),
    thanhtiennhap NUMBER,
    CONSTRAINT fk_chitietphieunhap_nguyenlieu FOREIGN KEY ( manl )
        REFERENCES nguyenlieu ( manguyenlieu ),
    CONSTRAINT fk_chitietphieunhap_phieunhap FOREIGN KEY ( mapn )
        REFERENCES phieunhap ( maphieunhap ),
    CONSTRAINT fk_chitietphieunhap_nhanvien FOREIGN KEY ( manv )
        REFERENCES nhanvien ( manhanvien )
);
CREATE TABLE loaimonan
(
    maloaimonan CHAR(10) NOT NULL PRIMARY KEY,
    tenloaimonan NVARCHAR2(100)
)
-------------------BANG MENU----------------------
CREATE TABLE menu (
    mamonan      CHAR(10) NOT NULL PRIMARY KEY,
    hinhanhmonan NVARCHAR2(255) NOT NULL,
    tenmonan     NVARCHAR2(50) NOT NULL,
    giaban       NUMBER CHECK ( giaban > 0 ),
    maloai CHAR(10), CONSTRAINT fk_menu_loaimonan FOREIGN KEY ( maloai )
        REFERENCES loaimonan ( maloaimonan )
);
-------------------BANG BAN----------------------
CREATE TABLE ban (
    maban       NUMBER
        GENERATED BY DEFAULT AS IDENTITY
    NOT NULL PRIMARY KEY,
    soban      NUMBER NOT NULL,
    kiemtraban NVARCHAR2(20) NOT NULL CHECK ( kiemtraban IN ( 'Trong', 'Khong trong' ) ),
    UNIQUE ( soban )
);
-----------------BANG HOA DON---------------------
CREATE TABLE hoadon (
    mahoadon        NUMBER
        GENERATED BY DEFAULT AS IDENTITY
    NOT NULL PRIMARY KEY,
    ngaylaphoadon  DATE NOT NULL,
    tongtienhoadon NUMBER
);

------------------BANG CHI TIET HOA DON----------------
CREATE TABLE chitiethoadon (
    machitiethd NUMBER
        GENERATED BY DEFAULT AS IDENTITY
    NOT NULL PRIMARY KEY,
    mahd        NUMBER,
    maban       NUMBER,
    mama        CHAR(10),
    manv        CHAR(10),
    soluonghd   NUMBER CHECK ( soluonghd > 0 ),
    thanhtienhd NUMBER,
    CONSTRAINT fk_chitiethoadon_hoadon FOREIGN KEY ( mahd )
        REFERENCES hoadon ( mahoadon ),
    CONSTRAINT fk_chitiethoadon_ban FOREIGN KEY ( maban )
        REFERENCES ban ( maban ),
    CONSTRAINT fk_chitiethoadon_menu FOREIGN KEY ( mama )
        REFERENCES menu ( mamonan ),
    CONSTRAINT fk_chitiethoadon_nhanvien FOREIGN KEY ( manv )
        REFERENCES nhanvien ( manhanvien )
);
--------------------------------------------------------------------------------
------------------------------B) TAO CAC CHI MUC-----------------------------------


--------------------------------------------------------------------------------
--Chi muc cho cot tennv trong 
CREATE INDEX idx_tennv ON nhanvien(tennv);
--Chi muc cho cot manhanvien trong bang nhanvien:
CREATE INDEX idx_manhanvien ON nhanvien(manhanvien);
--Chi muc cho cot ngaysinh trong bang nhanvien:
CREATE INDEX idx_ngaysinh ON nhanvien(ngaysinh);
--Chi m?c cho cot mancc trong bang phieunhap:
CREATE INDEX idx_mancc_phieunhap ON phieunhap(mancc);
--Chi muc cho cot manguyenlieu trong bang chitietphieunhap:
CREATE INDEX idx_manguyenlieu_ctpn ON chitietphieunhap(manl);
--Chi muc cho cot mama trong bang chitiethoadon:
CREATE INDEX idx_mama_chitiethoadon ON chitiethoadon(mama);
--Chi muc cho cot manv trong bang chitiethoadon:
CREATE INDEX idx_manv_chitiethoadon ON chitiethoadon(manv);
--Chi muc cho cot maban trong bang chitiethoadon:
CREATE INDEX idx_maban_chitiethoadon ON chitiethoadon(maban);
--Chi muc cho cot mahoadon trong bang chitiethoadon:
CREATE INDEX idx_mahoadon_chitiethoadon ON chitiethoadon(mahd);
--------------------------------------------------------------------------------

------------------------------C) THEM DU LIEU-----------------------------------


--------------------------------------------------------------------------------
-----------BANG NHAN VIEN--------------
INSERT INTO nhanvien (
    manhanvien,
    tennv,
    ngaysinh,
    gioitinh,
    sdt,
    chucvu
) VALUES (
    'NV01',
    'Nguyen Duy Anh',
    TO_DATE('17/11/2003', 'DD/MM/YYYY'),
    'Nam',
    '0367383187',
    'Quan li'
);

INSERT INTO nhanvien (
    manhanvien,
    tennv,
    ngaysinh,
    gioitinh,
    sdt,
    chucvu
) VALUES (
    'NV02',
    'Nguyen Thi Truc',
    TO_DATE('29/04/2002', 'DD/MM/YYYY'),
    'Nu',
    '0335396317',
    'Nhan vien tai quay'
);

INSERT INTO nhanvien (
    manhanvien,
    tennv,
    ngaysinh,
    gioitinh,
    sdt,
    chucvu
) VALUES (
    'NV03',
    'Nguyen Lan Nhu',
    TO_DATE('27/07/2002', 'DD/MM/YYYY'),
    'Nu',
    '0355752574',
    'Nhan vien tai quay'
);

INSERT INTO nhanvien (
    manhanvien,
    tennv,
    ngaysinh,
    gioitinh,
    sdt,
    chucvu
) VALUES (
    'NV04',
    'Tran Ngoc Nhan',
    TO_DATE('15/10/2001', 'DD/MM/YYYY'),
    'Nam',
    '0522546803',
    'Nhan vien tai quay'
);


select *From bangchamcong
----------------BANG CHAM CONG-----------------
INSERT INTO bangchamcong (
    manhanvien,
    calam,
    giobatdaulam,
    gioketthuclam
) VALUES (
    'NV02',
    'Ca Sang',
    TO_TIMESTAMP('08:00:00', 'HH24:MI:SS'),
    TO_TIMESTAMP('12:00:00', 'HH24:MI:SS')
);

-------------------BANG TAI KHOAN----------------------
INSERT INTO taikhoan (
    username,
    password,
    quyentruycap,
    manv
) VALUES (
    'NhanVien01',
    '123',
    0,
    'NV01'
);

INSERT INTO taikhoan (
    username,
    password,
    quyentruycap,
    manv
) VALUES (
    'NhanVien02',
    '456',
    1,
    'NV02'
);

INSERT INTO taikhoan (
    username,
    password,
    quyentruycap,
    manv
) VALUES (
    'NhanVien03',
    '789',
    1,
    'NV03'
);

INSERT INTO taikhoan (
    username,
    password,
    quyentruycap,
    manv
) VALUES (
    'NhanVien04',
    '910',
    1,
    'NV04'
);

----------------THEM BANG NGUYEN LIEU---------------------
INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL01',
    'Bot mi',
    'Kg'
);

INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL02',
    'Gao',
    'Kg'
);

INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL03',
    'Tom',
    'Kg'
);

INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL04',
    'Rau cai',
    'Bo'
);

INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL05',
    'Thit bo',
    'Kg'
);

INSERT INTO nguyenlieu (
    manguyenlieu,
    tennguyenlieu,
    donvitinh
) VALUES (
    'NL06',
    'Ca phe',
    'Goi'
);



    
------------------------THEM NHA CUNG CAP------------------------

INSERT INTO nhacungcap (
    mancc,
    tenncc,
    diachincc
) VALUES (
    'NCC01',
    'C?ng ty TNHH Hai San Vung Tau',
    '140 Le Trong Tan Tan Phu TPHCM'
);

INSERT INTO nhacungcap (
    mancc,
    tenncc,
    diachincc
) VALUES (
    'NCC02',
    'Cong ty An Toan Thuc Pham Rau Sach',
    '475 Au Co Tan Phu TPHCM'
);
----------------THEM LOAI MON AN-------------------------
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L01', 'Mon Sup');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L02', 'Mon Salad');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L03', 'Mon An Sang');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L04', 'Mon Kho');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L05', 'Lau');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L06', 'Mon Canh');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L07', 'Nuoc Giai Khat');
INSERT INTO loaimonan (maloaimonan, tenloaimonan) VALUES ('L08', 'Mon An Cung Com');

----------------------THEM BANG MENU---------------------
INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA01', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\saladchay.jpg', 'Salad Tron Rau Cu', 50000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA02', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\saladhoaqua.jpg', 'Salad Hoa Qua', 105000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA03', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\goingusac.jpg', 'Goi Ngu Sac', 85000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA04', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\dudusotchuacay.jpg', 'Du Du Sot Chua Cay', 95000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA05', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\saladkhoaitay.jpg', 'Salad Khoai Gion', 85000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA06', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\saladcudensotchanhday.jpg', 'Salad Cu Den Sot Chanh Day', 105000, 'L02');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA07', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\bunbochay.jpg', 'Bun Bo Chay', 55000, 'L03');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA08', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\photronchay.jpg', 'Pho Tron Chay', 45000, 'L03');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA09', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\banhmichamsua.jpg', 'Banh Mi Cham Sua', 35000, 'L03');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA10', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\pepsi.jpg', 'Pepsi', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA11', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\nuocsuoi.jpg', 'Nuoc Suoi', 23000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA12', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\sting.jpg', 'Sting', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA13', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\redbull.jpg', 'Redbull', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA14', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\traolong.jpg', 'Tra O Long', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA15', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\revive.jpg', 'Revive Chanh Muoi', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA16', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\bayup.jpg', '7 Up', 30000, 'L07');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA17', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\lauhoadongnoi.jpg', 'Lau Hoa Dong Noi', 350000, 'L05');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA18', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\lauthaichuacay.jpg', 'Lau Thai Chua Cay', 350000, 'L05');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA19', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\lautruongtho.jpg', 'Lau Truong Tho', 99000, 'L05');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA20', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\mangtayxaonam.jpg', 'Mang Tay Xao Nam', 180000, 'L08');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA21', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\rauluoc.jpg', 'Rau Luoc Kho Quet', 95000, 'L08');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA22', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\namduiga.jpg', 'Nam Dui Ga Sot Ca', 90000, 'L08');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA23', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\namsottieu.jpg', 'Nam Sot Tieu Xanh', 70000, 'L08');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA24', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\supthapcap.jpeg', 'Sup Tham Cam', 12000, 'L01');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA25', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\supdaudo.jpeg', 'Sup Dau Do', 130000, 'L01');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA26', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\supbap.jpeg', 'Sup Bap', 80000, 'L01');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA27', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\supbido.jpeg', 'Sup Bi Do', 90000, 'L01');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA28', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\suprongbien.jpeg', 'Sup Rong Bien', 110000, 'L01');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA29', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\khoquakho.jpeg', 'Kho Qua Kho', 79000, 'L04');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA30', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\namkho.jpg', 'Nam Kho', 89000, 'L04');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA31', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\suonnonkho.jpeg', 'Suon Non Kho', 110000, 'L04');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA32', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\raucukho.jpg', 'Rau Cu Kho', 60000, 'L04');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA33', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\dauhukho.jpg', 'Dau Hu Kho', 60000, 'L04');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA34', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\canhrongbien.jpg', 'Canh Rong Bien', 80000, 'L06');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA35', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\canhhoatiet.jpg', 'Canh Hoa Tiet', 75000, 'L06');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA36', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\canhchua.jpg', 'Canh Chua Chay', 65000, 'L06');

INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai) VALUES 
('MA37', 'D:\HocKi6\T6_OracleLab_11\HinhAnh\canhkhoqua.jpg', 'Canh Kho Qua', 65000, 'L06');


-----------------THEM BANG PHIEU NHAP-----------------------
INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN001',
    TO_DATE('2024-01-15', 'YYYY-MM-DD'),
    0,
    'NCC01'
);

INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN002',
    TO_DATE('2024-02-20', 'YYYY-MM-DD'),
    0,
    'NCC02'
);

INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN003',
    TO_DATE('2024-03-25', 'YYYY-MM-DD'),
    0,
    'NCC01'
);

INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN004',
    TO_DATE('2024-04-30', 'YYYY-MM-DD'),
    0,
    'NCC02'
);

INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN005',
    TO_DATE('2024-05-10', 'YYYY-MM-DD'),
    0,
    'NCC02'
);

INSERT INTO phieunhap (
    maphieunhap,
    ngaynhap,
    tongtiennhap,
    mancc
) VALUES (
    'PN006',
    TO_DATE('2024-05-15', 'YYYY-MM-DD'),
    0,
    'NCC01'
);


-------------------BANG CHI TIET PHIEU NHAP-------------------------

INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN001',
    'NL01',
    'PN001',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    100,
    5000,
    0
);

INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN002',
    'NL02',
    'PN002',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    200,
    4500,
    0
);

INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN003',
    'NL03',
    'PN003',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    150,
    6000,
    0
);


INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN004',
    'NL04',
    'PN004',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    250,
    4000,
    0
);

INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN005',
    'NL05',
    'PN005',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    300,
    3500,
    0
);

INSERT INTO chitietphieunhap (
    mactpn,
    manl,
    mapn,
    manv,
    hansudung,
    soluongnhap,
    dongianhap,
    thanhtiennhap
) VALUES (
    'CTPN006',
    'NL06',
    'PN005',
    'NV01',
    TO_DATE('2024-05-31', 'YYYY-MM-DD'),
    300,
    3500,
    0
);

--------------------THEM BANG BAN------------------

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    1,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    2,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    3,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    4,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    5,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    6,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    7,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    8,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
   
    9,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    10,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    11,
    'Trong'
);

INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    12,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    13,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    14,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    15,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    16,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    17,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    18,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    19,
    'Trong'
);
INSERT INTO ban (
    soban,
    kiemtraban
) VALUES (
    20,
    'Trong'
);

-------------------THEM BANG HOA DON--------------------
INSERT INTO hoadon (
    ngaylaphoadon,
    tongtienhoadon
) VALUES (
    TO_DATE('2024-04-20', 'YYYY-MM-DD'),
    0
);

INSERT INTO hoadon (
    ngaylaphoadon,
    tongtienhoadon
) VALUES (
    TO_DATE('2024-04-21', 'YYYY-MM-DD'),
    0
);

INSERT INTO hoadon (
    ngaylaphoadon,
    tongtienhoadon
) VALUES (
    TO_DATE('2024-04-22', 'YYYY-MM-DD'),
    0
);
----------------------THEM BANG CHI TIET HOA DON-------------------------

INSERT INTO chitiethoadon (
    mahd,
    maban,
    mama,
    manv,
    soluonghd,
    thanhtienhd
) VALUES (
    1,
    1,
    'MA01',
    'NV02',
    2,
    0
);

INSERT INTO chitiethoadon (
    mahd,
    maban,
    mama,
    manv,
    soluonghd,
    thanhtienhd
) VALUES (
    2,
    2,
    'MA01',
    'NV02',
    1,
    0
);

INSERT INTO chitiethoadon (
    mahd,
    maban,
    mama,
    manv,
    soluonghd,
    thanhtienhd
) VALUES (
    3,
    3,
    'MA01',
    'NV02',
    3,
    0
);

UPDATE chitiethoadon cthd
SET
    thanhtienhd = (
        SELECT
            cthd.soluonghd * m.giaban
        FROM
            menu m
        WHERE
            cthd.mama = m.mamonan
    );


UPDATE hoadon hd
SET
    tongtienhoadon = (
        SELECT
            SUM(cthd.thanhtienhd)
        FROM
            chitiethoadon cthd
        WHERE
            hd.mahoadon = cthd.mahd
    );

UPDATE chitietphieunhap ctpn
SET
    thanhtiennhap = ctpn.soluongnhap * ctpn.dongianhap;

UPDATE phieunhap pn
SET
    tongtiennhap = (
        SELECT
            SUM(ctpn.thanhtiennhap)
        FROM
            chitietphieunhap ctpn
        WHERE
            pn.maphieunhap = ctpn.mapn
    );
--------------------------------------------------------------------------------


------------------------------D) CAC CAU THU TUC--------------------------------


--------------------------------------------------------------------------------
-----------------------THU TUC THEM NHAN VIEN------------------
-- Tran Khoi Nguyen-2001210245
CREATE OR REPLACE PROCEDURE themnhanvien (
    p_manhanvien CHAR,
    p_tennv      NVARCHAR2,
    p_ngaysinh   DATE,
    p_gioitinh   NVARCHAR2,
    p_sdt        CHAR,
    p_chucvu     NVARCHAR2
) IS
BEGIN
    IF p_gioitinh NOT IN ('Nam', 'Nu') THEN
        RAISE_APPLICATION_ERROR(-20001, 'Gioi tinh chi co the la "Nam" hoac "Nu".');
    END IF;

    IF p_chucvu NOT IN ('Quan li', 'Nhan vien tai quay') THEN
        RAISE_APPLICATION_ERROR(-20002, 'Chuc vu chi co the la "Quan li" hoac "Nhan vien tai quay".');
    END IF;

    IF LENGTH(p_sdt) != 10 THEN
        RAISE_APPLICATION_ERROR(-20003, 'So dien thoai phai co do dai 10 ky tu.');
    END IF;

    INSERT INTO nhanvien (manhanvien, tennv, ngaysinh, gioitinh, sdt, chucvu)
    VALUES (p_manhanvien, p_tennv, p_ngaysinh, p_gioitinh, p_sdt, p_chucvu);

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20004, 'Da xay ra loi khi them nhan vien: ' || SQLERRM);
END;

---------------------------------------------------------
------------GOI THU TUC-------------
BEGIN
    themnhanvien('NV05', 'Nguyen Duy Khang', TO_DATE('2003-04-27', 'YYYY-MM-DD'), 'Nam', '0522546803', 'Nhan vien tai quay');
END;

----------------------------------------------------------------------------------
----------------------HIEN THI DANH SACH NHAN VIEN------------------
-- Tran Khoi Nguyen-2001210245
CREATE OR REPLACE PROCEDURE hien_thi_nhanvien(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT tennv, sdt, chucvu FROM NhanVien;
END;

SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_tennv NhanVien.tennv%TYPE;
    v_sdt NhanVien.sdt%TYPE;
    v_chucvu NhanVien.chucvu%TYPE;
BEGIN
    hien_thi_nhanvien(v_cursor);

    LOOP
        FETCH v_cursor INTO v_tennv, v_sdt, v_chucvu;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Ten NV: ' || v_tennv || ', SDT: ' || v_sdt || ', Chuc Vu: ' || v_chucvu);
    END LOOP;

    CLOSE v_cursor;
END;

--------------------------------------------------------------------------------
------------------THU TUC XOA NHAN VIEN---------------
-- Tran Khoi Nguyen-2001210245
CREATE OR REPLACE PROCEDURE xoaNhanVien (
    p_MaNhanVien IN nhanvien.manhanvien%TYPE
)
AS
BEGIN
    DELETE FROM nhanvien
    WHERE manhanvien = p_MaNhanVien;
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END xoaNhanVien;

--------------------------------------------------------------------------------
------------------GOI THU TUC XOA NHAN VIEN---------------------

BEGIN
    xoaNhanVien('NV05');
END;

--------------------------------------------------------------------------------
-----------------THU TUC SUA NHAN VIEN----------------------
-- Tran Khoi Nguyen-2001210245
CREATE OR REPLACE PROCEDURE sua_nhanvien(
    p_tennv IN NVARCHAR2,
    p_ngaysinh IN DATE,
    p_gioitinh IN NVARCHAR2,
    p_sdt IN CHAR,
    p_chucvu IN NVARCHAR2,
    p_manhanvien IN CHAR
)
IS
BEGIN
    UPDATE nhanvien
    SET tennv = p_tennv,
        ngaysinh = p_ngaysinh,
        gioitinh = p_gioitinh,
        sdt = p_sdt,
        chucvu = p_chucvu
    WHERE manhanvien = p_manhanvien;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Cap nhat thanh cong.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Loi khi cap nhat nhan vien: ' || SQLERRM);
END;

-------------------GOI THU TUC SUA NHAN VIEN-------------------------
BEGIN
    sua_nhanvien(
        
        p_tennv => 'Cao Minh Tri',
        p_ngaysinh => TO_DATE('2003-12-22', 'YYYY-MM-DD'),
        p_gioitinh => 'Nam',
        p_sdt => '0367383187',
        p_chucvu => 'Nhan vien tai quay',
        
        p_manhanvien => 'NV04'
    );
END; 

-------------------------------------------------------
------------THEM TAI KHOAN MOI-----------------
--Nguyen Duy Khang 2001210246
CREATE OR REPLACE PROCEDURE themtaikhoan (
    p_username     IN NVARCHAR2,
    p_password     IN NVARCHAR2,
    p_quyentruycap IN NUMBER,
    p_manv         IN CHAR
) IS
    v_count NUMBER;
BEGIN
    IF p_quyentruycap NOT IN (0, 1) THEN
        RAISE_APPLICATION_ERROR(-20001, 'quyentruycap must be 0 or 1');
    END IF;
    SELECT COUNT(*)
    INTO v_count
    FROM nhanvien
    WHERE manhanvien = p_manv;
    
    IF v_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'manv does not exist in nhanvien');
    END IF;
    INSERT INTO taikhoan (username, password, quyentruycap, manv)
    VALUES (p_username, p_password, p_quyentruycap, p_manv);

EXCEPTION
    WHEN DUP_VAL_ON_INDEX THEN
        RAISE_APPLICATION_ERROR(-20003, 'Username or Password already exists');
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20004, 'An unexpected error occurred: ' || SQLERRM);
END themtaikhoan;

-------------------------------------------------------
-----------------GOI THU TUC--------------------

BEGIN
    themtaikhoan('NhanVien04','910',1,'NV04');
END;
----------------------HIEN THI DANH SACH TAI KHOAN------------------
CREATE OR REPLACE PROCEDURE hien_thi_tai_khoan(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT username, password, quyentruycap FROM taikhoan;
END;

-------------------GOI THU TUC---------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_username taikhoan.username%TYPE;
    v_password taikhoan.password%TYPE;
    v_quyentruycap taikhoan.quyentruycap%TYPE;
BEGIN
   hien_thi_tai_khoan(v_cursor);

    LOOP
        FETCH v_cursor INTO v_username, v_password, v_quyentruycap;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('UserName: ' || v_username || ', Passwoord: ' || v_password || ', QuyenTruyCap: ' || v_quyentruycap);
    END LOOP;

    CLOSE v_cursor;
END;

---------------------------------------------------------
-----------XOA TAI KHOAN-------------------
CREATE OR REPLACE PROCEDURE xoataikhoan (
    p_username IN NVARCHAR2
) IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*)
    INTO v_count
    FROM taikhoan
    WHERE username = p_username;
    
    IF v_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Username does not exist');
    END IF;

    DELETE FROM taikhoan
    WHERE username = p_username;

    DBMS_OUTPUT.PUT_LINE('Account with username ' || p_username || ' has been deleted.');

EXCEPTION
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20002, 'An unexpected error occurred: ' || SQLERRM);
END xoataikhoan;
----------------------------------------------------
-------------GOI THU TUC---------------
BEGIN
    xoataikhoan('NhanVien04');
END;


---------------CAP NHAT TAI KHOAN----------------
CREATE OR REPLACE PROCEDURE capnhattaikhoan (
    p_quyentruycap  IN NUMBER,
    p_username IN NVARCHAR2
) AS
BEGIN
    UPDATE taikhoan
    SET 
        quyentruycap = p_quyentruycap
    WHERE username = p_username;
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        RAISE_APPLICATION_ERROR(-20002, 'Loi khi cap nhap: ' || SQLERRM);
END capnhattaikhoan;    
---------------GOI THU TUC----------------
BEGIN
    capnhattaikhoan(
        p_quyentruycap => 1,
        p_username => 'NhanVien04'
    );
END;




--------------------------------------------------------------------------------
-------------------------THU TUC THEM NGUYEN LIEU-------------------------------
CREATE OR REPLACE PROCEDURE themnguyenlieu(
    p_manguyenlieu  IN CHAR,
    p_tennguyenlieu IN NVARCHAR2,
    p_donvitinh     IN NVARCHAR2
)
IS
BEGIN
    IF p_donvitinh NOT IN ('Chai','Kg','Con','Goi','Bo','Qua') THEN
        RAISE_APPLICATION_ERROR(-20001, 'Don vi tinh gom co chai, kg, con, bo, qua');
    END IF;
    INSERT INTO nguyenlieu (manguyenlieu, tennguyenlieu, donvitinh)
    VALUES (p_manguyenlieu, p_tennguyenlieu, p_donvitinh);
   
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002,'Da xay ra loi khi them nguyen lieu: '|| SQLERRM);
END;
------------------GOI THU TUC-------------------
BEGIN
    themnguyenlieu('NL07', 'Thit heo', 'Kg');
    themnguyenlieu('NL08', 'Rau muong', 'Bo');
END;


select *From nguyenlieu;
-----------------HIEN THI DANH SACH NGUYEN LIEU-------------------------
CREATE OR REPLACE PROCEDURE hien_thi_nguyen_lieu(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM nguyenlieu;
END;
-------------------GOI THU TUC---------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_manguyenlieu nguyenlieu.manguyenlieu%TYPE;
    v_tennguyenlieu nguyenlieu.tennguyenlieu%TYPE;
    v_donvitinh nguyenlieu.donvitinh%TYPE;
BEGIN
   hien_thi_nguyen_lieu(v_cursor);

    LOOP
        FETCH v_cursor INTO v_manguyenlieu, v_tennguyenlieu, v_donvitinh;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaNguyenLieu: ' || v_manguyenlieu || ',TenNguyenLieu: ' || v_tennguyenlieu || ', DonViTinh: ' || v_donvitinh);
    END LOOP;

    CLOSE v_cursor;
END;




--------------------------------------------------------------------------------
------------------------XOA NGUYEN LIEU-----------------------------
CREATE OR REPLACE PROCEDURE xoaNguyenLieu(
    p_manguyenlieu IN nguyenlieu.manguyenlieu%TYPE
)
AS
BEGIN
    DELETE FROM nguyenlieu
    WHERE manguyenlieu=p_manguyenlieu;
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END xoaNguyenLieu;
-----------------------GOI THU TUC---------------------------
BEGIN
    xoaNguyenlieu('NL08');
END;


--------------------------SUA NGUYEN LIEU---------------------
CREATE OR REPLACE PROCEDURE sua_nguyenlieu(
    p_tennguyenlieu IN NVARCHAR2,
    p_donvitinh IN NVARCHAR2,
    P_manguyenlieu IN CHAR
)
IS
BEGIN
    UPDATE nguyenlieu
    SET tennguyenlieu = p_tennguyenlieu,
        donvitinh=p_donvitinh
    WHERE manguyenlieu = p_manguyenlieu;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Cap nhat thanh cong.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Loi khi cap nhat nguyen lieu: ' || SQLERRM);
END;
--------------------------GOI THU TUC----------------------
BEGIN
    sua_nguyenlieu(
        p_tennguyenlieu => 'Thit ga',
        p_donvitinh => 'Kg',
        p_manguyenlieu => 'NL07'
    );
END;
select *from nguyenlieu;






--------------------------------------------------------------------------------
-----------------------BANG MENU--------------------
CREATE OR REPLACE PROCEDURE themmenu(
    p_mamonan  IN CHAR,
    p_hinhanhmonan IN NVARCHAR2,
    p_tenmonan     IN NVARCHAR2,
    p_giaban IN NUMBER,
    p_maloai IN CHAR
)
IS
BEGIN
    
    INSERT INTO menu (mamonan, hinhanhmonan, tenmonan, giaban, maloai)
    VALUES (p_mamonan, p_hinhanhmonan, p_tenmonan,p_giaban,p_maloai);
   
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002,'Da xay ra loi khi them menu: '|| SQLERRM);
END;
------------------GOI THU TUC-------------------
BEGIN
    themmenu('MA07', 'bunbo.jpg', 'Bun bo hue', 35000);
END;




----------------------HIEN THI DANH SACH MENU------------------
CREATE OR REPLACE PROCEDURE hien_thi_menu(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT mamonan, tenmonan, giaban FROM menu;
END;
---------------GOI THU TUC--------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_mamonan menu.mamonan%TYPE;
    v_tenmonan menu.tenmonan%TYPE;
    v_giaban menu.giaban%TYPE;
BEGIN
    hien_thi_menu(v_cursor);

    LOOP
        FETCH v_cursor INTO v_mamonan, v_tenmonan, v_giaban;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Ma mon an: ' || v_mamonan || ', Ten mon an: ' || v_tenmonan || ', Gia ban: ' || v_giaban);
    END LOOP;

    CLOSE v_cursor;
END;



-----------------XOA MENU-------------------
CREATE OR REPLACE PROCEDURE xoaMenu (
    p_mamonan IN menu.mamonan%TYPE
)
AS
BEGIN
    DELETE FROM menu
    WHERE mamonan = p_mamonan;
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END xoaMenu;
--------------------------------------------------------------------------------
------------------GOI THU TUC XOA NHAN VIEN---------------------
BEGIN
    xoaMenu('MA07');
END;



-----------------SUA MENU-----------------
CREATE OR REPLACE PROCEDURE sua_menu(
    p_hinhanhmonan IN NVARCHAR2,
    p_tenmonan IN NVARCHAR2,
    p_giaban IN NUMBER,
    p_mamonan IN CHAR
)
IS
BEGIN
    UPDATE menu
    SET hinhanhmonan = p_hinhanhmonan,
        tenmonan = p_tenmonan,
        giaban = p_giaban
    WHERE mamonan = p_mamonan;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Cap nhat thanh cong.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Loi khi cap nhat menu: ' || SQLERRM);
END;


-------------------GOI THU TUC SUA MENU-------------------------
BEGIN
    sua_menu(
        p_hinhanhmonan => 'D:\Downloads\miquang.jpg',
        p_tenmonan => 'Mi Quang',
        p_giaban => 50000,
        p_mamonan => 'MA01'
    );
END;



--------------------------------------------------------------------------------
---------------------THEM NHA CUNG CAP---------------------
CREATE OR REPLACE PROCEDURE themnhacungcap(
    p_mancc IN CHAR,
    p_tenncc IN NVARCHAR2,
    p_diachincc IN NVARCHAR2
)IS
BEGIN
    INSERT INTO nhacungcap(mancc,tenncc,diachincc)
    VALUES(p_mancc,p_tenncc,p_diachincc);
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002,'Da xay ra loi khi them nha cung cap: '|| SQLERRM);
END;
-----------------GOI THU TUC-----------------
BEGIN
    themnhacungcap('NCC03','Cong ty Ca Phe Thao Nguyen', '8 Do Cong Tuong Tan Phu TPHCM');
END;



------------------HIEN THI DANH SACH NHA CUNG CAP-------------------------
CREATE OR REPLACE PROCEDURE hien_thi_nha_cung_cap(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT tenncc, diachincc FROM nhacungcap;
END;
---------------GOI THU TUC--------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_tenncc nhacungcap.tenncc%TYPE;
    v_diachincc nhacungcap.diachincc%TYPE;
BEGIN
    hien_thi_nha_cung_cap(v_cursor);

    LOOP
        FETCH v_cursor INTO v_tenncc, v_diachincc;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Ten NCC: ' || v_tenncc || ', Dia chi NCC: ' || v_diachincc);
    END LOOP;

    CLOSE v_cursor;
END;




----------------XOA NHA CUNG CAP----------------------
CREATE OR REPLACE PROCEDURE xoaNhaCungCap (
    p_mancc IN nhacungcap.mancc%TYPE
)
AS
BEGIN
    DELETE FROM nhacungcap
    WHERE mancc = p_mancc;
    
    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END xoaNhaCungCap;
--------------------------------------------------------------------------------
------------------GOI THU TUC---------------------
BEGIN
    xoaNhaCungCap('NCC03');
END;




-------------SUA NHA CUNG CAP---------------
CREATE OR REPLACE PROCEDURE sua_nhacungcap(
    p_tenncc IN NVARCHAR2,
    p_diachincc IN NVARCHAR2,
    p_mancc IN CHAR
)
IS
BEGIN
    UPDATE nhacungcap
    SET tenncc = p_tenncc,
        diachincc = p_diachincc
    WHERE mancc = p_mancc;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Cap nhat thanh cong.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Loi khi cap nhat nha cung cap: ' || SQLERRM);
END;


-------------------GOI THU TUC-------------------------
BEGIN
    sua_nhacungcap(
        p_tenncc => 'Cong ty Ca Phe Thao Nguyen',
        p_diachincc => '8 Do Cong Tuong Tan Phu TPHCM',
        p_mancc => 'NCC03'
    );
END;
select *from nhacungcap;





--------------------THEM PHIEU NHAP---------------------
CREATE OR REPLACE PROCEDURE themphieunhap(
    p_maphieunhap IN CHAR,
    p_ngaynhap IN DATE,
    p_mancc IN CHAR
)IS
BEGIN
    INSERT INTO phieunhap(maphieunhap,ngaynhap,mancc)
    VALUES(p_maphieunhap,p_ngaynhap,p_mancc);
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002,'Da xay ra loi khi them phieu nhap: '|| SQLERRM);
END;
-----------------GOI THU TUC-----------------
BEGIN
    themphieunhap('PN007',TO_DATE('2024-05-15', 'YYYY-MM-DD'),'NCC03');
END;



-----------------HIEN THI DANH SACH PHIEU NHAP-----------------------
CREATE OR REPLACE PROCEDURE hien_thi_phieu_nhap(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT * FROM phieunhap;
END;
---------------GOI THU TUC--------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_mapn phieunhap.maphieunhap%TYPE;
    v_ngaynhap phieunhap.ngaynhap%TYPE;
    v_tongtiennhap phieunhap.tongtiennhap%TYPE;
    v_mancc phieunhap.mancc%TYPE;
BEGIN
    hien_thi_phieu_nhap(v_cursor);

    LOOP
        FETCH v_cursor INTO v_mapn,v_ngaynhap, v_tongtiennhap,v_mancc;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('TenNCC: '|| v_mapn || ', NgayNhap: ' || v_ngaynhap || ', TongTienNhap: ' || v_tongtiennhap ||', TenNCC: '|| v_mancc);
    END LOOP;

    CLOSE v_cursor;
END;



------------------SUA PHIEU NHAP------------------
CREATE OR REPLACE PROCEDURE sua_phieunhap(
    p_ngaynhap IN DATE,
    p_maphieunhap IN CHAR
)
IS
BEGIN
    UPDATE phieunhap
    SET ngaynhap = p_ngaynhap
    WHERE maphieunhap = p_maphieunhap;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('Cap nhat thanh cong.');
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        DBMS_OUTPUT.PUT_LINE('Loi khi cap nhat phieu nhap: ' || SQLERRM);
END;


-------------------GOI THU TUC-------------------------
BEGIN
    sua_phieunhap(
        p_ngaynhap => TO_DATE('2024-05-10', 'YYYY-MM-DD'),
        p_maphieunhap => 'PN007'
    );
END;
select *from phieunhap;



-------------CAP NHAT TONG TIEN PHIEU NHAP------------------
CREATE OR REPLACE PROCEDURE update_tongtiennhap IS
BEGIN
    FOR rec IN (
        SELECT mapn, SUM(thanhtiennhap) AS total_amount
        FROM chitietphieunhap
        GROUP BY mapn
    ) LOOP
        UPDATE phieunhap
        SET tongtiennhap = rec.total_amount
        WHERE maphieunhap = rec.mapn;
    END LOOP;
END;
--------------GOI THU TUC------------------
BEGIN
    update_tongtiennhap;
END;






----------------------THEM CHI TIET PHIEU NHAP-------------------
CREATE OR REPLACE PROCEDURE themchitietphieunhap(
    p_mactpn        CHAR,
    p_manl          CHAR,
    p_mapn          CHAR,
    p_manv          CHAR,
    p_hansudung     DATE,
    p_soluongnhap   NUMBER,
    p_dongianhap    NUMBER,
    p_thanhtiennhap NUMBER
)IS
BEGIN
        INSERT INTO chitietphieunhap (
            mactpn, manl, mapn, manv, hansudung,
            soluongnhap, dongianhap, thanhtiennhap
    )
        VALUES (
            p_mactpn, p_manl, p_mapn, p_manv, p_hansudung,
            p_soluongnhap, p_dongianhap, p_thanhtiennhap
    );

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002,'Da xay ra loi khi them chi tiet phieu nhap: '|| SQLERRM);
END;
-----------------GOI THU TUC-----------------
BEGIN
    themchitietphieunhap('CTPN011','NL05',  'PN009',   'NV01', TO_DATE('2024-12-31', 'YYYY-MM-DD'), 100,6000, 0);
END;

---------------------CAP NHAP THANH TIEN TRONG CHI TIET PHIEU NHAP--------------
CREATE OR REPLACE PROCEDURE update_thanhtiennhap IS
BEGIN
    FOR rec IN (
        SELECT mactpn, soluongnhap, dongianhap
        FROM chitietphieunhap
    ) LOOP
        UPDATE chitietphieunhap
        SET thanhtiennhap = rec.soluongnhap * rec.dongianhap
        WHERE mactpn = rec.mactpn;
    END LOOP;
END;
----------------------------GOI THU TUC-----------------------
BEGIN
    update_thanhtiennhap;
END;



----------------------HIEN THI CHI TIET PHIEU NHAP------------------------
CREATE OR REPLACE PROCEDURE hien_thi_chi_tiet_pn(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT mapn, nguyenlieu.tennguyenlieu, hansudung, soluongnhap, thanhtiennhap, phieunhap.ngaynhap FROM chitietphieunhap JOIN nguyenlieu ON chitietphieunhap.manl = nguyenlieu.manguyenlieu JOIN phieunhap ON chitietphieunhap.mapn = phieunhap.maphieunhap;
END;
---------------GOI THU TUC--------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_mapn chitietphieunhap.mapn%TYPE;
    v_tennguyenlieu nguyenlieu.tennguyenlieu%TYPE;
    v_hansudung chitietphieunhap.hansudung%TYPE;
    v_soluongnhap chitietphieunhap.soluongnhap%TYPE;
    v_dongianhap chitietphieunhap.dongianhap%TYPE;
    v_thanhtiennhap chitietphieunhap.thanhtiennhap%TYPE;
    v_ngaynhap phieunhap.ngaynhap%TYPE;
BEGIN
    hien_thi_chi_tiet_pn(v_cursor);

    LOOP
        FETCH v_cursor INTO v_mapn,v_tennguyenlieu, v_hansudung,v_soluongnhap,v_thanhtiennhap,v_ngaynhap;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaPN: ' || v_mapn|| ', TenNguyenLieu: ' || v_tennguyenlieu || ', HanSuDung: ' || v_hansudung ||', SoLuong: '|| v_soluongnhap||', ThanhTienNhap: '|| v_thanhtiennhap ||', NgayNhap: '|| v_ngaynhap);
    END LOOP;

    CLOSE v_cursor;
END;



---------------HIEN THI CHI TIET HOA DON-----------------------
CREATE OR REPLACE PROCEDURE hien_thi_chi_tiet_hd(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT hoadon.mahoadon, menu.tenmonan, soluonghd, thanhtienhd, hoadon.ngaylaphoadon from  chitiethoadon JOIN hoadon ON chitiethoadon.mahd = hoadon.mahoadon JOIN menu ON chitiethoadon.mama = menu.mamonan;
END;

CREATE OR REPLACE PROCEDURE hien_thi_hd(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT *from hoadon;
END;




CREATE OR REPLACE PROCEDURE updateTongTien IS
BEGIN

    -- Update the tong tien hoa don (total invoice amount) in the hoadon table
    UPDATE hoadon hd
    SET tongtienhoadon = (
        SELECT SUM(cthd.thanhtienhd)
        FROM chitiethoadon cthd
        WHERE hd.mahoadon = cthd.mahd
    );
END updateTongTien;


CREATE OR REPLACE PROCEDURE hien_thi_bang_cham_cong(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT nhanvien.tennv, nhanvien.chucvu, calam, sogiolam from bangchamcong,nhanvien where nhanvien.manhanvien=bangchamcong.manhanvien;
END;

-------------------CAP NHAT SO GIO LAM-------------------------
CREATE OR REPLACE PROCEDURE update_sogiolam AS
BEGIN
    UPDATE bangchamcong
    SET sogiolam = (EXTRACT(HOUR FROM (gioketthuclam - giobatdaulam)) +
                EXTRACT(MINUTE FROM (gioketthuclam - giobatdaulam))/60)
    WHERE sogiolam IS NULL;
END update_sogiolam;

--------------THU TUC THEM HOA DON--------------
---Nguyen Minh Nha 2001210550
CREATE OR REPLACE PROCEDURE themhoadon (
    p_mahoadon       IN CHAR,
    p_ngaylaphoadon  IN DATE,
    p_tongtienhoadon IN NUMBER
) IS
BEGIN
    INSERT INTO hoadon (mahoadon, ngaylaphoadon, tongtienhoadon)
    VALUES (p_mahoadon, p_ngaylaphoadon, p_tongtienhoadon);
COMMIT;
EXCEPTION
    WHEN OTHERS THEN 
    ROLLBACK;
    RAISE_APPLICATION_ERROR(-20001, ' L?i khi thêm hóa ??n: '|| SQLERRM);
END;

--------------GOI THU TUC THEM HOA DON--------------
BEGIN
    themhoadon('HD04', TO_DATE('2024-5-24', 'YYYY-MM-DD'), 150000);
END;
select * from hoadon;

-------------CAP NHAT TONG TIEN HOA DON------------------
CREATE OR REPLACE PROCEDURE update_tongtienhoadon  IS
BEGIN
    FOR rec IN (
        SELECT mahd, SUM(thanhtienhd) AS total_amount
        FROM chitiethoadon
        GROUP BY mahd
    ) LOOP
        UPDATE hoadon
        SET tongtienhoadon = rec.total_amount
        WHERE mahoadon = rec.mahd;
    END LOOP;
END;
--------------GOI THU TUC------------------
BEGIN
    update_tongtienhoadon;
END;
select * from hoadon;

--------------HIEN THI DANH SACH HOA DON------------------
CREATE OR REPLACE PROCEDURE hien_thi_hoa_don(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT ngaylaphoadon, tongtienhoadon
    FROM hoadon;
END;
---------------GOI THU TUC--------------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_ngaylaphoadon hoadon.ngaylaphoadon%TYPE;
    v_tongtienhoadon hoadon.tongtienhoadon%TYPE;
BEGIN
    hien_thi_hoa_don(v_cursor);

    LOOP
        FETCH v_cursor INTO v_ngaylaphoadon, v_tongtienhoadon;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Ngay lap hoa don: ' || TO_CHAR(v_ngaylaphoadon, 'DD-MM-YYYY') || ', Tong tien hoa don: ' || v_tongtienhoadon);
    END LOOP;

    CLOSE v_cursor;
END;

--------------THU TUC THEM CHI TIET HOA DON--------------
CREATE OR REPLACE PROCEDURE them_chitiet_hoadon (
    p_mahd        IN NUMBER,
    p_maban       IN NUMBER,
    p_mama        IN CHAR,
    p_manv        IN CHAR,
    p_soluonghd   IN NUMBER,
    p_thanhtienhd IN NUMBER
) AS
BEGIN
    -- Insert a new record into the chitiethoadon table
    INSERT INTO chitiethoadon (
        mahd, maban, mama, manv, soluonghd, thanhtienhd
    ) VALUES (
        p_mahd, p_maban, p_mama, p_manv, p_soluonghd, p_thanhtienhd
    );
END them_chitiet_hoadon;

--------------CAP NHAT THANH TIEN TRONG CHI TIET HOA DON--------------
CREATE OR REPLACE PROCEDURE update_thanhtienhoadon IS
BEGIN
    FOR rec IN (
        SELECT machitiethd, soluonghd, thanhtienhd
        FROM chitiethoadon
    ) LOOP
        UPDATE chitiethoadon
        SET thanhtienhd = rec.soluonghd * rec.thanhtienhd
        WHERE machitiethd = rec.machitiethd;
    END LOOP;
END;

--------------GOI THU TUC--------------
BEGIN
    update_thanhtienhoadon;
END;
select * from chitiethoadon;

----------------------HIEN THI CHI TIET HOA DON------------------------
CREATE OR REPLACE PROCEDURE hien_thi_chi_tiet_hoadon(p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
    SELECT menu.tenmonan, soluonghd, thanhtienhd
    FROM chitiethoadon, menu
    WHERE chitiethoadon.mama = menu.mamonan;
END;
--------------GOI THU TUC--------------
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_tenmonan menu.tenmonan%TYPE;
    v_soluonghd chitiethoadon.soluonghd%TYPE;
    v_thanhtienhd chitiethoadon.thanhtienhd%TYPE;
BEGIN
    hien_thi_chi_tiet_hoadon(v_cursor);

    LOOP
        FETCH v_cursor INTO v_tenmonan, v_soluonghd, v_thanhtienhd;
        EXIT WHEN v_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Ten mon an: ' || v_tenmonan || ', So luong: ' || v_soluonghd || ', Thanh tien: ' || v_thanhtienhd);
    END LOOP;

    CLOSE v_cursor;
END;


--------------------------------------------------------------------------------


--------------------------------E) TRIGGER--------------------------------------
-----Nguyen Minh Nha 2001210550
CREATE OR REPLACE TRIGGER before_chitietphieunhap_trigger
BEFORE INSERT OR UPDATE ON chitietphieunhap
FOR EACH ROW
BEGIN
    IF :NEW.soluongnhap IS NOT NULL AND :NEW.dongianhap IS NOT NULL THEN
        :NEW.thanhtiennhap := :NEW.soluongnhap * :NEW.dongianhap;
    END IF;
END;
--------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER after_chitiethoadon_trigger
AFTER INSERT OR UPDATE OR DELETE ON chitiethoadon
FOR EACH ROW
DECLARE
    total_amount NUMBER;
BEGIN
    IF INSERTING OR UPDATING THEN
        SELECT SUM(soluonghd * thanhtienhd) INTO total_amount
        FROM chitiethoadon
        WHERE mahd = :NEW.mahd;

        UPDATE hoadon
        SET tongtienhoadon = total_amount
        WHERE mahoadon = :NEW.mahd;
    ELSIF DELETING THEN
        SELECT SUM(soluonghd * thanhtienhd) INTO total_amount
        FROM chitiethoadon
        WHERE mahd = :OLD.mahd;

        UPDATE hoadon
        SET tongtienhoadon = total_amount
        WHERE mahoadon = :OLD.mahd;
    END IF;
END;

--------Nguyen Duy Khang 2001210246
CREATE OR REPLACE TRIGGER before_insert_nhanvien
BEFORE INSERT ON nhanvien
FOR EACH ROW
BEGIN
    IF :NEW.gioitinh NOT IN ('Nam', 'Nu') THEN
        RAISE_APPLICATION_ERROR(-20001, 'Gi?i tính ph?i là "Nam" ho?c "Nu"');
    END IF;
    IF :NEW.chucvu NOT IN ('Quan li', 'Nhan vien tai quay') THEN
        RAISE_APPLICATION_ERROR(-20002, 'Ch?c v? ph?i là "Quan li" ho?c "Nhan vien tai quay"');
    END IF;
END;
--------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER after_insert_chitietphieunhap
AFTER INSERT ON chitietphieunhap
FOR EACH ROW
DECLARE
    v_thanhtien NUMBER;
BEGIN
    SELECT SUM(soluongnhap * dongianhap) INTO v_thanhtien
    FROM chitietphieunhap
    WHERE mapn = :NEW.mapn;
    
    UPDATE phieunhap
    SET tongtiennhap = v_thanhtien
    WHERE maphieunhap = :NEW.mapn;
END;
-----Tran Khoi Nguyen 2001210245
CREATE OR REPLACE TRIGGER before_insert_phieunhap
BEFORE INSERT ON phieunhap
FOR EACH ROW
BEGIN
    IF :new.ngaynhap IS NULL THEN
        :new.ngaynhap := SYSDATE;
    END IF;
END;
--------------------------------------------------------------------------------
CREATE OR REPLACE TRIGGER after_delete_nhanvien
AFTER DELETE ON nhanvien
FOR EACH ROW
DECLARE
    v_deleted_manhanvien nhanvien.manhanvien%TYPE;
BEGIN
    v_deleted_manhanvien := :old.manhanvien;
    DELETE FROM taikhoan WHERE manv = v_deleted_manhanvien;
    DELETE FROM bangchamcong WHERE manhanvien = v_deleted_manhanvien;
END;
--------------------------------------------------------------------------------


--------------------------------------------------------------------------------


------------------------------F) CAC CAU TRUY VAN--------------------------------


--------------------------------------------------------------------------------
-- Tran Khoi Nguyen-2001210245
--Cau 1:
SELECT n.tennv, n.sdt, n.chucvu
FROM nhanvien n
WHERE n.chucvu = 'Quan li'
ORDER BY n.tennv;
--Cau 2:
SELECT b.soban, SUM(c.soluonghd) AS soluongmonan
FROM chitiethoadon c
JOIN ban b ON c.maban = b.maban
GROUP BY b.soban
HAVING SUM(c.soluonghd) > 5
ORDER BY soluongmonan;
--Cau 3:
SELECT nc.tenncc, SUM(pn.tongtiennhap) AS tongtiennhap
FROM phieunhap pn
JOIN nhacungcap nc ON pn.mancc = nc.mancc
GROUP BY nc.tenncc
HAVING SUM(pn.tongtiennhap) > 1000000
ORDER BY tongtiennhap;

-- Nguyen Duy Khang-2001210246
--Cau 1:
SELECT m.tenmonan, m.giaban
FROM menu m
WHERE m.giaban > 0
ORDER BY m.giaban DESC;
--Cau 2:
SELECT nl.tennguyenlieu, SUM(ctpn.soluongnhap) AS tongsoluongnhap
FROM chitietphieunhap ctpn
JOIN nguyenlieu nl ON ctpn.manl = nl.manguyenlieu
GROUP BY nl.tennguyenlieu
HAVING SUM(ctpn.soluongnhap) > 100
ORDER BY tongsoluongnhap;
--Cau3
SELECT m.tenmonan, SUM(cthd.thanhtienhd) AS tongtienban
FROM chitiethoadon cthd
JOIN menu m ON cthd.mama = m.mamonan
GROUP BY m.tenmonan
HAVING SUM(cthd.thanhtienhd) > 2000
ORDER BY tongtienban;
-- Nguyen Minh Nha-2001210550
--Cau 1:
SELECT m.tenmonan
FROM menu m
LEFT JOIN chitiethoadon cthd ON m.mamonan = cthd.mama
WHERE cthd.mama IS NULL
ORDER BY m.tenmonan;
--Cau 2:
SELECT chitiethoadon.maban, SUM(chitiethoadon.thanhtienhd) AS doanhthu
FROM chitiethoadon
JOIN hoadon ON chitiethoadon.mahd = hoadon.mahoadon
GROUP BY chitiethoadon.maban
HAVING SUM(chitiethoadon.thanhtienhd) > 200000
ORDER BY doanhthu DESC;
--Cau 3:
SELECT chitiethoadon.manv, COUNT(hoadon.mahoadon) AS soluonghoadon
FROM chitiethoadon
JOIN hoadon ON chitiethoadon.mahd = hoadon.mahoadon
GROUP BY chitiethoadon.manv
HAVING COUNT(hoadon.mahoadon) > 5
ORDER BY soluonghoadon DESC;
--------------------------------------------------------------------------------


---------------------------------G) CAC HAM----------------------------------


--------------------------------------------------------------------------------
-- Tran Khoi Nguyen-2001210245
--1 Tinh tuoi nhan vien
CREATE OR REPLACE FUNCTION tinhtuoinhanvien (
    p_manhanvien CHAR
) RETURN NUMBER IS
    v_ngaysinh DATE;
    v_age NUMBER;
BEGIN
    SELECT ngaysinh INTO v_ngaysinh FROM nhanvien WHERE manhanvien = p_manhanvien;

    IF v_ngaysinh IS NULL THEN
        RETURN NULL;
    ELSE
        v_age := TRUNC(MONTHS_BETWEEN(SYSDATE, v_ngaysinh) / 12);
        RETURN v_age;
    END IF;
END;

SELECT manhanvien, tinhtuoinhanvien(manhanvien) AS age FROM nhanvien;
SELECT tinhtuoinhanvien('NV01') AS age FROM dual;

--2 Kiem tra gioi tinh nhan vien
CREATE OR REPLACE FUNCTION kiemtragioitinhnhanvien (
    p_manhanvien CHAR
) RETURN NVARCHAR2 IS
    v_gioitinh NVARCHAR2(3);
BEGIN
    SELECT gioitinh INTO v_gioitinh FROM nhanvien WHERE manhanvien = p_manhanvien;

    IF v_gioitinh = 'Nam' THEN
        RETURN 'Nam';
    ELSIF v_gioitinh = 'Nu' THEN
        RETURN 'Nu';
    ELSE
        RETURN 'Unknown';
    END IF;
END;

SELECT manhanvien, kiemtragioitinhnhanvien(manhanvien) AS gender FROM nhanvien;
SELECT kiemtragioitinhnhanvien('NV04') AS gender FROM dual;

-- Nguyen Duy Khang-2001210246
--1 Tinh tong doanh thu theo nhan vien
CREATE OR REPLACE FUNCTION tinhtongdoanhthutheonhanvien (
    p_manhanvien CHAR
) RETURN NUMBER IS
    v_total_sales NUMBER := 0;
BEGIN
    FOR rec IN (SELECT thanhtienhd FROM chitiethoadon WHERE manv = p_manhanvien) LOOP
        v_total_sales := v_total_sales + rec.thanhtienhd;
    END LOOP;
    RETURN v_total_sales;
END;

SELECT manhanvien, tinhtongdoanhthutheonhanvien(manhanvien) AS total_sales FROM nhanvien;
SELECT tinhtongdoanhthutheonhanvien('NV02') AS total_sales FROM dual;

--2 Kiem tra tinh trang ban
CREATE OR REPLACE FUNCTION kiemtratinhtrangban (
    p_maban NUMBER
) RETURN NVARCHAR2 IS
    v_kiemtraban NVARCHAR2(20);
BEGIN
    SELECT kiemtraban INTO v_kiemtraban FROM ban WHERE maban = p_maban;

    IF v_kiemtraban = 'Trong' THEN
        RETURN 'Trong';
    ELSIF v_kiemtraban = 'Khong trong' THEN
        RETURN 'Khong trong';
    ELSE
        RETURN 'Unknown';
    END IF;
END;

SELECT maban, kiemtratinhtrangban(maban) AS status FROM ban;
SELECT kiemtratinhtrangban(1) AS status FROM dual;

-- Nguyen Minh Nha-2001210550
--1 Tinh tong tien nguyen lieu
CREATE OR REPLACE FUNCTION tongtiennguyenlieu (
    p_manguyenlieu CHAR
) RETURN NUMBER IS
    v_total_cost NUMBER := 0;
BEGIN
    FOR rec IN (SELECT thanhtiennhap FROM chitietphieunhap WHERE manl = p_manguyenlieu) LOOP
        v_total_cost := v_total_cost + rec.thanhtiennhap;
    END LOOP;
    RETURN v_total_cost;
END;

SELECT manguyenlieu, tongtiennguyenlieu(manguyenlieu) AS total_cost FROM nguyenlieu;
SELECT tongtiennguyenlieu('NL02') AS total_cost FROM dual;

--2 Kiem tra chuc vu nhan vien
CREATE OR REPLACE FUNCTION kiemtrachucvunhanvien (
    p_manhanvien CHAR
) RETURN NVARCHAR2 IS
    v_chucvu NVARCHAR2(30);
BEGIN
    IF p_manhanvien IS NULL THEN
        RETURN 'Invalid Input';
    END IF;

    SELECT chucvu INTO v_chucvu FROM nhanvien WHERE manhanvien = p_manhanvien;

    RETURN v_chucvu;
END;

SELECT manhanvien, kiemtrachucvunhanvien(manhanvien) AS position FROM nhanvien;
SELECT kiemtrachucvunhanvien('NV01') AS position FROM dual;


------THU TUC FORM NHAN VIEN-------
-----Nguyen Duy Khang 2001210246
----SHOW TAT CA NHAN VIEN----
CREATE OR REPLACE PROCEDURE showALLNhanVien(
    p_nhanvien_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN p_nhanvien_cursor FOR
        SELECT *FROM nhanvien;
END;
-----GOI THU TUC-----
SET SERVEROUTPUT ON;
DECLARE
    v_nhanvien_cursor SYS_REFCURSOR;
    v_manhanvien nhanvien.manhanvien%TYPE;
    v_tennv nhanvien.tennv%TYPE;
    v_ngaysinh nhanvien.ngaysinh%TYPE;
    v_gioitinh nhanvien.gioitinh%TYPE;
    v_sdt nhanvien.sdt%TYPE;
    v_chucvu nhanvien.chucvu%TYPE;
BEGIN
    showALLNhanVien(v_nhanvien_cursor);

    LOOP
        FETCH v_nhanvien_cursor INTO v_manhanvien, v_tennv, v_ngaysinh, v_gioitinh, v_sdt, v_chucvu;
        EXIT WHEN v_nhanvien_cursor%NOTFOUND;
        
        DBMS_OUTPUT.PUT_LINE('manhanvien: ' || v_manhanvien || 
                             ', tennv: ' || v_tennv || 
                             ', ngaysinh: ' || v_ngaysinh || 
                             ', gioitinh: ' || v_gioitinh || 
                             ', sdt: ' || v_sdt || 
                             ', chucvu: ' || v_chucvu);
    END LOOP;  
    CLOSE v_nhanvien_cursor;
END;
----SHOW CHUC VU CUA NHAN VIEN NV01 VA NV02
CREATE OR REPLACE PROCEDURE showChucVuNhanVien(
    p_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN p_cursor FOR
        SELECT ChucVu
        FROM NhanVien
        WHERE MaNhanVien IN ('NV01', 'NV02');
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_cursor SYS_REFCURSOR;
    v_chucvu nhanvien.chucvu%TYPE;
BEGIN
    showChucVuNhanVien(v_cursor);
    LOOP
        FETCH v_cursor INTO v_chucvu;
        EXIT WHEN v_cursor%NOTFOUND;     
        DBMS_OUTPUT.PUT_LINE('ChucVu: ' || v_chucvu);
    END LOOP; 
    CLOSE v_cursor;
END;
----TIM KIEM NHAN VIEN THEO TEN----
CREATE OR REPLACE PROCEDURE timNhanVien(
    p_tenNV IN NVARCHAR2,
    p_nhanvien_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN p_nhanvien_cursor FOR
        SELECT tennv, sdt, chucvu
        FROM nhanvien
        WHERE tennv LIKE '%' || p_tenNV || '%';
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_ten NVARCHAR2(100) := 'Nguyen';
    v_nhanvien_cursor SYS_REFCURSOR;
    v_tennv nhanvien.tennv%TYPE;
    v_sdt nhanvien.sdt%TYPE;
    v_chucvu nhanvien.chucvu%TYPE;
BEGIN
    timNhanVien(v_ten, v_nhanvien_cursor);
    LOOP
        FETCH v_nhanvien_cursor INTO v_tennv, v_sdt, v_chucvu;
        EXIT WHEN v_nhanvien_cursor%NOTFOUND;

        -- Output the results
        DBMS_OUTPUT.PUT_LINE('TenNV: ' || v_tennv || ', SDT: ' || v_sdt || ', ChucVu: ' || v_chucvu);
    END LOOP;
    CLOSE v_nhanvien_cursor;
END;


----THU TUC FORM BANG CHAM CONG----
----SHOW TAT CA DU LIEU TRONG BANG CHAM CONG
CREATE OR REPLACE PROCEDURE showALLBangChamCong(
    p_nhanvien_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN p_nhanvien_cursor FOR
        SELECT *FROM bangchamcong;
END;
-----GOI THU TUC-----
SET SERVEROUTPUT ON;
DECLARE
  v_cursor SYS_REFCURSOR;
  v_machamcong bangchamcong.machamcong%TYPE;
  v_manhanvien bangchamcong.manhanvien%TYPE;
  v_calam bangchamcong.calam%TYPE;
  v_giobatdaulam bangchamcong.giobatdaulam%TYPE;
  v_gioketthuclam bangchamcong.gioketthuclam%TYPE;
  v_sogiolam bangchamcong.sogiolam%TYPE;
BEGIN
  showALLBangChamCong(v_cursor);
  LOOP
    FETCH v_cursor INTO v_machamcong, v_manhanvien, v_calam, v_giobatdaulam, v_gioketthuclam, v_sogiolam;
    EXIT WHEN v_cursor%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE('Machamcong: ' || v_machamcong || ', Manhanvien: ' || v_manhanvien || ', Calam: ' || v_calam || ', Giobatdaulam: ' || v_giobatdaulam || ', Gioketthuclam: ' || v_gioketthuclam || ', Sogiolam: ' || v_sogiolam);
  END LOOP;
  CLOSE v_cursor;
END;
----BAT DAU LAM VIEC----
CREATE OR REPLACE PROCEDURE bat_dau_lam_viec(
    p_manv VARCHAR2,
    p_giobatdau TIMESTAMP
) AS
BEGIN
    INSERT INTO bangchamcong (manhanvien, giobatdaulam)
    VALUES (p_manv, p_giobatdau);
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('B?t ??u làm vi?c');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('L?i khi b?t ??u làm vi?c: ' || SQLERRM);
END bat_dau_lam_viec;
----GOI THU TUC----
SET SERVEROUTPUT ON;
BEGIN
    bat_dau_lam_viec('NV02', TO_TIMESTAMP('08:00:00', 'HH24:MI:SS'));
END;
----KET THUC LAM VIEC----
CREATE OR REPLACE PROCEDURE ket_thuc_lam_viec(
    p_manv VARCHAR2,
    p_gioketthuc TIMESTAMP
) AS
    v_rows_updated NUMBER;
BEGIN
    UPDATE bangchamcong
    SET gioketthuclam = p_gioketthuc
    WHERE manhanvien = p_manv
    AND gioketthuclam IS NULL;

    v_rows_updated := SQL%ROWCOUNT;

    IF v_rows_updated > 0 THEN
        DBMS_OUTPUT.PUT_LINE('Th?i gian k?t thúc ???c ghi l?i thành công.');
    ELSE
        DBMS_OUTPUT.PUT_LINE('Không th? c?p nh?t th?i gian k?t thúc.');
    END IF;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('L?i khi c?p nh?t th?i gian k?t thúc: ' || SQLERRM);
END ket_thuc_lam_viec;


-----THU TUC MENU----
----SHOW TAT CA MENU---
CREATE OR REPLACE PROCEDURE GET_MENU_LIST(
    menu_list OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN menu_list FOR
    SELECT * FROM menu;
END GET_MENU_LIST;
----TIM KIEM MENU THEO TEN MON AN
CREATE OR REPLACE PROCEDURE timMenu(
    p_tenmonan IN NVARCHAR2,
    p_nhanvien_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN p_nhanvien_cursor FOR
        SELECT mamonan, tenmonan, giaban
        FROM menu
        WHERE tenmonan LIKE '%' || p_tenmonan || '%';
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_ten NVARCHAR2(100) := 'Ga';
    v_nhanvien_cursor SYS_REFCURSOR;
    v_mamonan menu.mamonan%TYPE;
    v_tenmonan menu.tenmonan%TYPE;
    v_giaban menu.giaban%TYPE;
BEGIN
    timMenu(v_ten, v_nhanvien_cursor);
    LOOP
        FETCH v_nhanvien_cursor INTO v_mamonan, v_tenmonan, v_giaban;
        EXIT WHEN v_nhanvien_cursor%NOTFOUND;

        -- Output the results
        DBMS_OUTPUT.PUT_LINE('TenNV: ' || v_mamonan || ', SDT: ' || v_tenmonan || ', ChucVu: ' || v_giaban);
    END LOOP;
    CLOSE v_nhanvien_cursor;
END;


------THU TUC FORM DANG NHAP-------
CREATE OR REPLACE PROCEDURE showNhanVien (
    p_nhanvien_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN p_nhanvien_cursor FOR
        SELECT manhanvien, tennv
        FROM nhanvien;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_nhanvien_cursor SYS_REFCURSOR;
    v_manhanvien VARCHAR2(50);
    v_tennv VARCHAR2(100);
BEGIN
    showNhanVien(v_nhanvien_cursor);
    LOOP
        FETCH v_nhanvien_cursor INTO v_manhanvien, v_tennv;
        EXIT WHEN v_nhanvien_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('manhanvien: ' || v_manhanvien || ', tennv: ' || v_tennv);
    END LOOP;
    CLOSE v_nhanvien_cursor;
END;


-----THU TUC FORM TAI KHOAN-----
-----SHOW MA NHAN VIEN-----
CREATE OR REPLACE PROCEDURE showMaNhanVien(
    p_cbMaNhanVien OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cbMaNhanVien FOR
        SELECT manhanvien
        FROM nhanvien;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_nhanvien_cursor SYS_REFCURSOR;
    v_manhanvien VARCHAR2(50);
BEGIN
    showMaNhanVien(v_nhanvien_cursor);
    LOOP
        FETCH v_nhanvien_cursor INTO v_manhanvien;
        EXIT WHEN v_nhanvien_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('manhanvien: ' || v_manhanvien);
    END LOOP;
    CLOSE v_nhanvien_cursor;
END;
-----SHOW TAT CA TAI KHOAN------
CREATE OR REPLACE PROCEDURE showAllAccount (
    p_listTaiKhoan OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_listTaiKhoan FOR
        SELECT username, password, quyentruycap, manv
        FROM taikhoan;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_listTaiKhoan SYS_REFCURSOR;
    v_username taikhoan.username%TYPE;
    v_password taikhoan.password%TYPE;
    v_quyentruycap taikhoan.quyentruycap%TYPE;
    v_manv taikhoan.manv%TYPE;
BEGIN
    showAllAccount(v_listTaiKhoan);
    LOOP
        FETCH v_listTaiKhoan INTO v_username, v_password, v_quyentruycap, v_manv;
        EXIT WHEN v_listTaiKhoan%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Username: ' || v_username || ', Password: ' || v_password || ', Quyentruycap: ' || v_quyentruycap || ', Manv: ' || v_manv);
    END LOOP;
    CLOSE v_listTaiKhoan;
END;
----SHOW QUYEN TRUY CAP VOI MADN 1 VA MADN 2
CREATE OR REPLACE PROCEDURE showQuyenTruyCap (
    p_cbQuyenTruyCap OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cbQuyenTruyCap FOR
        SELECT quyentruycap
        FROM taikhoan
        WHERE madn = 1 OR madn = 2;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    v_cbQuyenTruyCap SYS_REFCURSOR;
    v_quyentruycap taikhoan.quyentruycap%TYPE;
BEGIN
    showQuyenTruyCap(v_cbQuyenTruyCap);
    LOOP
        FETCH v_cbQuyenTruyCap INTO v_quyentruycap;
        EXIT WHEN v_cbQuyenTruyCap%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Quyentruycap: ' || v_quyentruycap);
    END LOOP;
    CLOSE v_cbQuyenTruyCap;
END;


-----THU TUC PHIEU NHAP-----
-----SHOW TAT CA PHIEU NHAP----
CREATE OR REPLACE PROCEDURE showALLPhieuNhap(
    p_phieunhap_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN p_phieunhap_cursor FOR
        SELECT *FROM phieunhap;
END;
-----GOI THU TUC-----
SET SERVEROUTPUT ON;
DECLARE
    v_phieunhap_cursor SYS_REFCURSOR;
    v_maphieunhap phieunhap.maphieunhap%TYPE;
    v_ngaynhap phieunhap.ngaynhap%TYPE;
    v_tongtiennhap phieunhap.tongtiennhap%TYPE;
    v_mancc phieunhap.mancc%TYPE;
BEGIN
    showALLPhieuNhap(v_phieunhap_cursor);
    LOOP
        FETCH v_phieunhap_cursor INTO v_maphieunhap, v_ngaynhap, v_tongtiennhap, v_mancc;
        EXIT WHEN v_phieunhap_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Maphieunhap: ' || v_maphieunhap || ', Ngaynhap: ' || TO_CHAR(v_ngaynhap, 'DD/MM/YYYY') || ', Tongtiennhap: ' || v_tongtiennhap || ', Mancc: ' || v_mancc);
    END LOOP;
    CLOSE v_phieunhap_cursor;
END;
-----SHOW TAT CA NGUYEN LIEU----
CREATE OR REPLACE PROCEDURE GET_NGUYENLIEU_LIST(
    nguyenlieu_list OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN nguyenlieu_list FOR
    SELECT * FROM nguyenlieu;
END GET_NGUYENLIEU_LIST;


-----SHOW MA NHA CUNG CAP----
CREATE OR REPLACE PROCEDURE showMaNCC(
    p_nhacungcap OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_nhacungcap FOR
        SELECT mancc
        FROM nhacungcap;
END;
-----GOI THU TUC-----
SET SERVEROUTPUT ON;
DECLARE
    -- Khai báo bi?n cursor ?? ch?a k?t qu? tr? v? t? th? t?c
    v_nhacungcap_cursor SYS_REFCURSOR;
    -- Khai báo bi?n ?? l?u tr? d? li?u t? cursor
    v_mancc nhacungcap.mancc%TYPE;
BEGIN
    -- G?i th? t?c và truy?n bi?n cursor ra ngoài ?? nh?n k?t qu?
    showMaNCC(v_nhacungcap_cursor);
    
    -- ??c d? li?u t? cursor và hi?n th?
    LOOP
        FETCH v_nhacungcap_cursor INTO v_mancc;
        EXIT WHEN v_nhacungcap_cursor%NOTFOUND;
        -- In ra màn hình các giá tr? c?a mã nhà cung c?p
        DBMS_OUTPUT.PUT_LINE('Mancc: ' || v_mancc);
    END LOOP;
    
    -- ?óng cursor sau khi s? d?ng
    CLOSE v_nhacungcap_cursor;
END;

----THU TUC FORM CHI TIET PHIEU NHAP----
---SHOW TAT CA CHI TIET PHIEU NHAP---
CREATE OR REPLACE PROCEDURE showALLCTPhieuNhap(
    p_phieunhap_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN p_phieunhap_cursor FOR
        SELECT *FROM chitietphieunhap;
END;
---GOI THU TUC---
SET SERVEROUTPUT ON;
DECLARE
    v_phieunhap_cursor SYS_REFCURSOR;
    v_mactpn chitietphieunhap.mactpn%TYPE;
    v_manl chitietphieunhap.manl%TYPE;
    v_mapn chitietphieunhap.mapn%TYPE;
    v_manv chitietphieunhap.manv%TYPE;
    v_hansudung chitietphieunhap.hansudung%TYPE;
    v_soluongnhap chitietphieunhap.soluongnhap%TYPE;
    v_dongianhap chitietphieunhap.dongianhap%TYPE;
    v_thanhtiennhap chitietphieunhap.thanhtiennhap%TYPE;
BEGIN
    showALLCTPhieuNhap(v_phieunhap_cursor);

    LOOP
        FETCH v_phieunhap_cursor INTO v_mactpn, v_manl, v_mapn, v_manv, v_hansudung, v_soluongnhap, v_dongianhap, v_thanhtiennhap;
        EXIT WHEN v_phieunhap_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Mactpn: ' || v_mactpn || ', Manl: ' || v_manl || ', Mapn: ' || v_mapn || ', Manv: ' || v_manv || ', Hansudung: ' || TO_CHAR(v_hansudung, 'DD/MM/YYYY') || ', Soluongnhap: ' || v_soluongnhap || ', Dongianhap: ' || v_dongianhap || ', Thanhtiennhap: ' || v_thanhtiennhap);
    END LOOP;
    CLOSE v_phieunhap_cursor;
END;
----SHOW MA PHIEU NHAP---
CREATE OR REPLACE PROCEDURE ShowCbPN(
    pn_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN pn_cursor FOR
        SELECT maphieunhap FROM phieunhap;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    pn_cursor SYS_REFCURSOR;
    v_maphieunhap phieunhap.maphieunhap%TYPE;
BEGIN
    ShowCbPN(pn_cursor);
    LOOP
        FETCH pn_cursor INTO v_maphieunhap;
        EXIT WHEN pn_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaPhieuNhap: ' || v_maphieunhap);
    END LOOP;
    CLOSE pn_cursor;
END;
----SHOW MA NGUYEN LIEU----
CREATE OR REPLACE PROCEDURE showCbNL(
    nl_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN nl_cursor FOR
        SELECT manguyenlieu,tennguyenlieu FROM nguyenlieu;
END;



----THU TUC BAN----
---SHOW SOBAN VA KIEMTRABAN---
CREATE OR REPLACE PROCEDURE loadTableStatus(
    table_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN table_cursor FOR
        SELECT soban, kiemtraban FROM ban;
END;
---GOI THU TUC---
SET SERVEROUTPUT ON;
DECLARE
    table_cursor SYS_REFCURSOR;
    v_soban ban.soban%TYPE;
    v_kiemtraban ban.kiemtraban%TYPE;
BEGIN
    loadTableStatus(table_cursor);
    LOOP
        FETCH table_cursor INTO v_soban, v_kiemtraban;
        EXIT WHEN table_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Soban: ' || v_soban || ', Kiemtraban: ' || v_kiemtraban);
    END LOOP;
    CLOSE table_cursor;
END;
---SHOW SOBAN VOI KIEMTRABAN TRONG
CREATE OR REPLACE PROCEDURE loadAvailableTables(
    table_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN table_cursor FOR
        SELECT soban FROM ban WHERE kiemtraban = 'Trong';
END;
---GOI THU TUC---
SET SERVEROUTPUT ON;
DECLARE
    table_cursor SYS_REFCURSOR;
    v_soban ban.soban%TYPE;
BEGIN
    loadAvailableTables(table_cursor);

    LOOP
        FETCH table_cursor INTO v_soban;
        EXIT WHEN table_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('Soban: ' || v_soban);
    END LOOP;
    CLOSE table_cursor;
END;
----THU TUC HOA DON----
CREATE OR REPLACE PROCEDURE getListHD(
    hd_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN hd_cursor FOR
        SELECT mahoadon, ngaylaphoadon, tongtienhoadon FROM hoadon;
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    hd_cursor SYS_REFCURSOR;
    v_mahoadon hoadon.mahoadon%TYPE;
    v_ngaylaphoadon hoadon.ngaylaphoadon%TYPE;
    v_tongtienhoadon hoadon.tongtienhoadon%TYPE;
BEGIN
    getListHD(hd_cursor);

    LOOP
        FETCH hd_cursor INTO v_mahoadon, v_ngaylaphoadon, v_tongtienhoadon;
        EXIT WHEN hd_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaHD: ' || v_mahoadon || ', NgayLapHD: ' || v_ngaylaphoadon || ', TongTien: ' || v_tongtienhoadon);
    END LOOP;
    CLOSE hd_cursor;
END;


----THU TUC CHI TIET HOA DON----
----SHOW TAT CA CHI TIET HOA DON----
CREATE OR REPLACE PROCEDURE getListCTHD(
    cthd_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN cthd_cursor FOR
        SELECT machitiethd, mahd, maban, mama, manv, soluonghd, thanhtienhd FROM chitiethoadon;
END;
----GOI THU TUC---
SET SERVEROUTPUT ON;
DECLARE
    cthd_cursor SYS_REFCURSOR;
    v_machitiethd chitiethoadon.machitiethd%TYPE;
    v_mahd chitiethoadon.mahd%TYPE;
    v_maban chitiethoadon.maban%TYPE;
    v_mama chitiethoadon.mama%TYPE;
    v_manv chitiethoadon.manv%TYPE;
    v_soluonghd chitiethoadon.soluonghd%TYPE;
    v_thanhtienhd chitiethoadon.thanhtienhd%TYPE;
BEGIN
    getListCTHD(cthd_cursor);
    LOOP
        FETCH cthd_cursor INTO v_machitiethd, v_mahd, v_maban, v_mama, v_manv, v_soluonghd, v_thanhtienhd;
        EXIT WHEN cthd_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaCTHD: ' || v_machitiethd || ', MaHD: ' || v_mahd || ', MaBan: ' || v_maban || ', MaMA: ' || v_mama || ', MaNV: ' || v_manv || ', SoLuong: ' || v_soluonghd || ', ThanhTien: ' || v_thanhtienhd);
    END LOOP;
    CLOSE cthd_cursor;
END;
----TIM KIEM THEO NGAY----
CREATE OR REPLACE PROCEDURE timKiemTheoNgay(
    ngayNhap IN VARCHAR2,
    result_cursor OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN result_cursor FOR
        SELECT hoadon.mahoadon, menu.tenmonan, chitiethoadon.soluonghd, chitiethoadon.thanhtienhd, hoadon.ngaylaphoadon
        FROM chitiethoadon
        JOIN hoadon ON chitiethoadon.mahd = hoadon.mahoadon
        JOIN menu ON chitiethoadon.mama = menu.mamonan
        WHERE hoadon.ngaylaphoadon = TO_DATE(ngayNhap, 'YYYY-MM-DD');
END;
----GOI THU TUC----
SET SERVEROUTPUT ON;
DECLARE
    result_cursor SYS_REFCURSOR;
    v_mahoadon hoadon.mahoadon%TYPE;
    v_tenmonan menu.tenmonan%TYPE;
    v_soluonghd chitiethoadon.soluonghd%TYPE;
    v_thanhtienhd chitiethoadon.thanhtienhd%TYPE;
    v_ngaylaphoadon hoadon.ngaylaphoadon%TYPE;
BEGIN
    timKiemTheoNgay('2023-06-01', result_cursor);
    LOOP
        FETCH result_cursor INTO v_mahoadon, v_tenmonan, v_soluonghd, v_thanhtienhd, v_ngaylaphoadon;
        EXIT WHEN result_cursor%NOTFOUND;
        DBMS_OUTPUT.PUT_LINE('MaHD: ' || v_mahoadon || ', TenMonAn: ' || v_tenmonan || ', SoLuong: ' || v_soluonghd || ', ThanhTien: ' || v_thanhtienhd || ', NgayLapHD: ' || v_ngaylaphoadon);
    END LOOP;
    CLOSE result_cursor;
END;
----THU TUC LOAI MON AN----
CREATE OR REPLACE PROCEDURE showAllLoaiMonAn(
    p_loai_cursor OUT SYS_REFCURSOR
)IS
BEGIN
    OPEN p_loai_cursor FOR
        SELECT *FROM loaimonan;
END;
